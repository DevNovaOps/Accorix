{% extends 'base.html' %}

{% block title %}Analytics Dashboard - ACCORIX{% endblock %}

{% block extra_css %}
<style>
.analytics-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.chart-card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 20px;
    transition: var(--transition);
    position: relative;
    overflow: hidden;
}

.chart-card:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-glow);
}

.chart-card::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0; height: 3px;
    background: linear-gradient(90deg, var(--primary), var(--secondary));
}

.chart-title {
    font-size: 1.1rem;
    font-weight: 600;
    color: var(--text);
    margin-bottom: 16px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.chart-container {
    text-align: center;
    min-height: 300px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.chart-container img {
    max-width: 100%;
    height: auto;
    border-radius: 8px;
}

.no-data {
    color: var(--muted);
    font-size: 0.9rem;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 12px;
}

.no-data svg {
    opacity: 0.3;
}

.kpi-enhanced {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.kpi-card-enhanced {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 24px;
    position: relative;
    overflow: hidden;
    transition: var(--transition);
}

.kpi-card-enhanced:hover {
    transform: translateY(-3px);
    box-shadow: var(--shadow-glow);
}

.kpi-card-enhanced::before {
    content: '';
    position: absolute;
    top: 0; left: 0; bottom: 0; width: 4px;
    background: var(--primary);
}

.kpi-card-enhanced.revenue::before { background: var(--success); }
.kpi-card-enhanced.expense::before { background: var(--danger); }
.kpi-card-enhanced.profit::before { background: var(--primary); }
.kpi-card-enhanced.outstanding::before { background: var(--warning); }

.kpi-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 12px;
}

.kpi-icon {
    width: 40px;
    height: 40px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0.8;
}

.kpi-icon.revenue { background: rgba(16,185,129,0.15); color: var(--success); }
.kpi-icon.expense { background: rgba(239,68,68,0.15); color: var(--danger); }
.kpi-icon.profit { background: rgba(0,245,255,0.15); color: var(--primary); }
.kpi-icon.outstanding { background: rgba(245,158,11,0.15); color: var(--warning); }

.kpi-label-enhanced {
    font-size: 0.9rem;
    color: var(--muted);
    text-transform: uppercase;
    font-weight: 600;
    letter-spacing: 0.5px;
}

.kpi-value-enhanced {
    font-size: 2rem;
    font-weight: 700;
    color: var(--text);
    margin: 8px 0;
}

.kpi-change {
    font-size: 0.8rem;
    display: flex;
    align-items: center;
    gap: 4px;
}

.kpi-change.positive { color: var(--success); }
.kpi-change.negative { color: var(--danger); }

.period-selector {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 20px;
}

.period-buttons {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
}

.period-btn {
    padding: 8px 16px;
    border: 1px solid var(--border);
    background: transparent;
    color: var(--text);
    border-radius: 6px;
    cursor: pointer;
    transition: var(--transition);
    font-size: 0.9rem;
}

.period-btn:hover, .period-btn.active {
    background: var(--primary);
    color: #000;
    border-color: var(--primary);
}

@media (max-width: 768px) {
    .analytics-grid {
        grid-template-columns: 1fr;
    }
    
    .kpi-enhanced {
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    }
    
    .kpi-value-enhanced {
        font-size: 1.5rem;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="page-title">
    <div>
        <h1>Analytics Dashboard</h1>
        <p style="color: var(--muted); margin: 0;">Financial insights and data visualization</p>
    </div>
    <div style="display: flex; gap: 10px;">
        <a href="{% url 'pdf_upload' %}" class="btn-secondary">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="margin-right: 8px;">
                <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/>
            </svg>
            Upload PDF
        </a>
        <a href="{% url 'pdf_list' %}" class="btn-primary">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="margin-right: 8px;">
                <path d="M13,9H18.5L13,3.5V9M6,2H14L20,8V20A2,2 0 0,1 18,22H6C4.89,22 4,21.1 4,20V4C4,2.89 4.89,2 6,2M15,18V16H6V18H15M18,14V12H6V14H18Z"/>
            </svg>
            View Documents
        </a>
    </div>
</div>

<!-- Period Selector -->
<div class="period-selector">
    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px;">
        <div>
            <h3 style="margin: 0; color: var(--text);">Report Period</h3>
            <p style="margin: 4px 0 0 0; color: var(--muted);">
                {{ start_date|date:"M d, Y" }} - {{ end_date|date:"M d, Y" }}
            </p>
        </div>
        <div class="period-buttons">
            <button class="period-btn" onclick="setPeriod('7d')">7 Days</button>
            <button class="period-btn" onclick="setPeriod('30d')">30 Days</button>
            <button class="period-btn" onclick="setPeriod('90d')">90 Days</button>
            <button class="period-btn active" onclick="setPeriod('1y')">1 Year</button>
            <button class="period-btn" onclick="setPeriod('all')">All Time</button>
        </div>
    </div>
</div>

<!-- Enhanced KPI Cards -->
<div class="kpi-enhanced">
    <div class="kpi-card-enhanced revenue">
        <div class="kpi-header">
            <div class="kpi-label-enhanced">Total Revenue</div>
            <div class="kpi-icon revenue">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M7,15H9C9,16.08 10.37,17 12,17C13.63,17 15,16.08 15,15C15,13.9 13.96,13.5 11.76,12.97C9.64,12.44 7,11.78 7,9C7,7.21 8.47,5.69 10.5,5.18V3H13.5V5.18C15.53,5.69 17,7.21 17,9H15C15,7.92 13.63,7 12,7C10.37,7 9,7.92 9,9C9,10.1 10.04,10.5 12.24,11.03C14.36,11.56 17,12.22 17,15C17,16.79 15.53,18.31 13.5,18.82V21H10.5V18.82C8.47,18.31 7,16.79 7,15Z"/>
                </svg>
            </div>
        </div>
        <div class="kpi-value-enhanced">₹{{ total_revenue|floatformat:0 }}</div>
        <div class="kpi-change positive">
            <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                <path d="M15,20H9V12H4.16L12,4.16L19.84,12H15V20Z"/>
            </svg>
            +12.5% from last period
        </div>
    </div>
    
    <div class="kpi-card-enhanced expense">
        <div class="kpi-header">
            <div class="kpi-label-enhanced">Total Expenses</div>
            <div class="kpi-icon expense">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M17,13H7V11H17V13Z"/>
                </svg>
            </div>
        </div>
        <div class="kpi-value-enhanced">₹{{ total_expenses|floatformat:0 }}</div>
        <div class="kpi-change negative">
            <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                <path d="M9,4H15V12H19.84L12,19.84L4.16,12H9V4Z"/>
            </svg>
            +8.3% from last period
        </div>
    </div>
    
    <div class="kpi-card-enhanced profit">
        <div class="kpi-header">
            <div class="kpi-label-enhanced">Net Profit</div>
            <div class="kpi-icon profit">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M16,6L18.29,8.29L13.41,13.17L9.41,9.17L2,16.59L3.41,18L9.41,12L13.41,16L19.71,9.71L22,12V6H16Z"/>
                </svg>
            </div>
        </div>
        <div class="kpi-value-enhanced" style="color: {% if net_profit >= 0 %}var(--success){% else %}var(--danger){% endif %};">
            ₹{{ net_profit|floatformat:0 }}
        </div>
        <div class="kpi-change {% if net_profit >= 0 %}positive{% else %}negative{% endif %}">
            <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                <path d="{% if net_profit >= 0 %}M15,20H9V12H4.16L12,4.16L19.84,12H15V20Z{% else %}M9,4H15V12H19.84L12,19.84L4.16,12H9V4Z{% endif %}"/>
            </svg>
            {% if net_profit >= 0 %}+{% endif %}{{ net_profit|floatformat:0 }} margin
        </div>
    </div>
    
    <div class="kpi-card-enhanced outstanding">
        <div class="kpi-header">
            <div class="kpi-label-enhanced">Outstanding</div>
            <div class="kpi-icon outstanding">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M12,17A1.5,1.5 0 0,1 10.5,15.5A1.5,1.5 0 0,1 12,14A1.5,1.5 0 0,1 13.5,15.5A1.5,1.5 0 0,1 12,17M12,13A1,1 0 0,1 11,12V8A1,1 0 0,1 12,7A1,1 0 0,1 13,8V12A1,1 0 0,1 12,13Z"/>
                </svg>
            </div>
        </div>
        <div class="kpi-value-enhanced">₹{{ outstanding_invoices|floatformat:0 }}</div>
        <div class="kpi-change">
            <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12,20A8,8 0 0,1 4,12A8,8 0 0,1 12,4A8,8 0 0,1 20,12A8,8 0 0,1 12,20M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2Z"/>
            </svg>
            Pending collection
        </div>
    </div>
</div>

<!-- Charts Section -->
<div class="analytics-grid">
    <!-- Revenue vs Expenses Chart -->
    <div class="chart-card">
        <div class="chart-title">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                <path d="M22,21H2V3H4V19H6V17H10V19H12V16H16V19H18V17H22V21Z"/>
            </svg>
            Revenue vs Expenses
        </div>
        <div class="chart-container">
            {% if revenue_chart %}
                <img src="data:image/png;base64,{{ revenue_chart }}" alt="Revenue vs Expenses Chart">
            {% else %}
                <div class="no-data">
                    <svg width="48" height="48" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M22,21H2V3H4V19H6V17H10V19H12V16H16V19H18V17H22V21Z"/>
                    </svg>
                    <div>No data available for chart</div>
                </div>
            {% endif %}
        </div>
    </div>
    
    <!-- Top Customers Chart -->
    <div class="chart-card">
        <div class="chart-title">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12,2A10,10 0 0,1 22,12A10,10 0 0,1 12,22A10,10 0 0,1 2,12A10,10 0 0,1 12,2M12,4A8,8 0 0,0 4,12A8,8 0 0,0 12,20A8,8 0 0,0 20,12A8,8 0 0,0 12,4Z"/>
            </svg>
            Top Customers
        </div>
        <div class="chart-container">
            {% if top_customers_chart %}
                <img src="data:image/png;base64,{{ top_customers_chart }}" alt="Top Customers Chart">
            {% else %}
                <div class="no-data">
                    <svg width="48" height="48" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12,2A10,10 0 0,1 22,12A10,10 0 0,1 12,22A10,10 0 0,1 2,12A10,10 0 0,1 12,2M12,4A8,8 0 0,0 4,12A8,8 0 0,0 12,20A8,8 0 0,0 20,12A8,8 0 0,0 12,4Z"/>
                    </svg>
                    <div>No customer data available</div>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Full Width Charts -->
<div style="display: grid; grid-template-columns: 1fr; gap: 20px;">
    <!-- Monthly Trends Chart -->
    <div class="chart-card">
        <div class="chart-title">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                <path d="M16,6L18.29,8.29L13.41,13.17L9.41,9.17L2,16.59L3.41,18L9.41,12L13.41,16L19.71,9.71L22,12V6H16Z"/>
            </svg>
            Monthly Financial Trends
        </div>
        <div class="chart-container">
            {% if monthly_trends_chart %}
                <img src="data:image/png;base64,{{ monthly_trends_chart }}" alt="Monthly Trends Chart">
            {% else %}
                <div class="no-data">
                    <svg width="48" height="48" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M16,6L18.29,8.29L13.41,13.17L9.41,9.17L2,16.59L3.41,18L9.41,12L13.41,16L19.71,9.71L22,12V6H16Z"/>
                    </svg>
                    <div>No trend data available</div>
                </div>
            {% endif %}
        </div>
    </div>
    
    <!-- Budget Variance Chart -->
    <div class="chart-card">
        <div class="chart-title">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                <path d="M19,3H5C3.9,3 3,3.9 3,5V19C3,20.1 3.9,21 5,21H19C20.1,21 21,20.1 21,19V5C21,3.9 20.1,3 19,3M19,19H5V5H19V19Z"/>
            </svg>
            Budget vs Actual Spending
        </div>
        <div class="chart-container">
            {% if budget_variance_chart %}
                <img src="data:image/png;base64,{{ budget_variance_chart }}" alt="Budget Variance Chart">
            {% else %}
                <div class="no-data">
                    <svg width="48" height="48" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M19,3H5C3.9,3 3,3.9 3,5V19C3,20.1 3.9,21 5,21H19C20.1,21 21,20.1 21,19V5C21,3.9 20.1,3 19,3M19,19H5V5H19V19Z"/>
                    </svg>
                    <div>No budget data available</div>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Action Buttons -->
<div class="card" style="margin-top: 20px;">
    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px;">
        <div>
            <h4 style="margin: 0; color: var(--text);">Analytics Actions</h4>
            <p style="margin: 4px 0 0 0; color: var(--muted);">
                Generate reports and export data
            </p>
        </div>
        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
            <button class="btn-secondary" onclick="refreshCharts()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="margin-right: 8px;">
                    <path d="M17.65,6.35C16.2,4.9 14.21,4 12,4A8,8 0 0,0 4,12A8,8 0 0,0 12,20C15.73,20 18.84,17.45 19.73,14H17.65C16.83,16.33 14.61,18 12,18A6,6 0 0,1 6,12A6,6 0 0,1 12,6C13.66,6 15.14,6.69 16.22,7.78L13,11H20V4L17.65,6.35Z"/>
                </svg>
                Refresh Data
            </button>
            <button class="btn-secondary" onclick="exportData()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="margin-right: 8px;">
                    <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/>
                </svg>
                Export CSV
            </button>
            <a href="{% url 'generate_custom_report' %}" class="btn-primary">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="margin-right: 8px;">
                    <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/>
                </svg>
                Generate Report
            </a>
        </div>
    </div>
</div>

<script>
function refreshCharts() {
    // Show loading state
    document.querySelectorAll('.chart-container img').forEach(img => {
        img.style.opacity = '0.5';
    });
    
    // Reload page after short delay
    setTimeout(() => {
        location.reload();
    }, 500);
}

function setPeriod(period) {
    // Update active button
    document.querySelectorAll('.period-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');
    
    // Redirect with period parameter
    const url = new URL(window.location);
    url.searchParams.set('period', period);
    window.location.href = url.toString();
}

function exportData() {
    // Create CSV export
    const csvData = [
        ['Metric', 'Value'],
        ['Total Revenue', '{{ total_revenue|floatformat:2 }}'],
        ['Total Expenses', '{{ total_expenses|floatformat:2 }}'],
        ['Net Profit', '{{ net_profit|floatformat:2 }}'],
        ['Outstanding Invoices', '{{ outstanding_invoices|floatformat:2 }}']
    ];
    
    const csvContent = csvData.map(row => row.join(',')).join('\n');
    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'analytics_data.csv';
    a.click();
    window.URL.revokeObjectURL(url);
}

// Auto-refresh every 5 minutes
setInterval(refreshCharts, 300000);
</script>
{% endblock %}